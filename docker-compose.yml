services:
  klaps-backend:
    image: ${IMAGE_NAME}:${IMAGE_TAG:-latest}
    container_name: ${CONTAINER_NAME:-klaps-backend}
    restart: always
    expose:
      - "${PORT}"
    env_file:
      - .env
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:${PORT}/api/v1/health",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      # HTTPS
      - "traefik.http.routers.${CONTAINER_NAME}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${CONTAINER_NAME}.entrypoints=websecure"
      - "traefik.http.routers.${CONTAINER_NAME}.tls.certresolver=leresolver"
      # HTTP redirect
      - "traefik.http.routers.${CONTAINER_NAME}-web.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${CONTAINER_NAME}-web.entrypoints=web"
      - "traefik.http.routers.${CONTAINER_NAME}-web.middlewares=redirect-to-https"
      # Service port
      - "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${PORT}"
    networks:
      - traefik_public

networks:
  traefik_public:
    external: true
